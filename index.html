<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Area Contact Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #wrap { display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
    #panel { padding: 12px; border-right: 1px solid #ddd; overflow:auto; }
    #map { height: 100%; }
    .row { display:flex; gap:8px; }
    input { width: 100%; padding: 8px; }
    button { padding: 8px 10px; }
    .hint { font-size: 12px; opacity: .75; margin-top: 6px; }
    @media (max-width: 900px) { #wrap { grid-template-columns: 1fr; grid-template-rows: 280px 1fr; } #panel { border-right: 0; border-bottom: 1px solid #ddd; } }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="panel">
      <h2>Find your area contact</h2>
      <div class="row">
        <input id="addr" placeholder="Enter your address" />
        <button id="go">Search</button>
      </div>
      <div class="hint">Tip: Use full street + city (e.g., “123 4th St, Grand Forks, ND”).</div>

      <hr />
      <div id="info">
        <p>Hover or click an area on the map, or search an address.</p>
      </div>
      <hr />
      <div class="hint">
        Map data © OpenStreetMap contributors.
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    const map = L.map("map").setView([47.93, -97.03], 12); // center between GF + EGF
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let geoLayer = null;
    let selectedLayer = null;

    function renderInfo(props) {
      const el = document.getElementById("info");
      el.innerHTML = `
        <h3>${props.name ?? "Area"}</h3>
        ${props.phone ? `<p><b>Phone:</b> ${props.phone}</p>` : ""}
        ${props.email ? `<p><b>Email:</b> <a href="mailto:${props.email}">${props.email}</a></p>` : ""}
        ${props.hours ? `<p><b>Hours:</b> ${props.hours}</p>` : ""}
        ${props.link ? `<p><a href="${props.link}" target="_blank" rel="noopener">More info</a></p>` : ""}
        ${props.notes ? `<p>${props.notes}</p>` : ""}
      `;
    }

    function setSelected(layer) {
      if (selectedLayer) selectedLayer.setStyle({ weight: 2, fillOpacity: 0.25 });
      selectedLayer = layer;
      selectedLayer.setStyle({ weight: 4, fillOpacity: 0.45 });
      selectedLayer.bringToFront();
      renderInfo(layer.feature.properties || {});
    }

    function style(feature) {
      return { weight: 2, fillOpacity: 0.25 };
    }

    function onEachFeature(feature, layer) {
      layer.on("mouseover", () => layer.setStyle({ weight: 3, fillOpacity: 0.35 }));
      layer.on("mouseout", () => {
        if (layer !== selectedLayer) layer.setStyle({ weight: 2, fillOpacity: 0.25 });
      });
      layer.on("click", () => setSelected(layer));
    }

    async function loadRegions() {
      const resp = await fetch("./regions.geojson");
      const geojson = await resp.json();
      geoLayer = L.geoJSON(geojson, { style, onEachFeature }).addTo(map);
      map.fitBounds(geoLayer.getBounds(), { padding: [20, 20] });
    }

    function findContainingFeature(pointLngLat, geojson) {
      const pt = turf.point(pointLngLat);
      for (const f of geojson.features) {
        if (turf.booleanPointInPolygon(pt, f)) return f;
      }
      return null;
    }

    async function geocodeAddress(q) {
      // Nominatim public endpoint (light use). Respect usage policy: low rate, identify app via Referer/User-Agent. :contentReference[oaicite:12]{index=12}
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");
      url.searchParams.set("q", q);
      const resp = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
      const data = await resp.json();
      if (!data?.length) return null;
      return { lat: Number(data[0].lat), lon: Number(data[0].lon), display: data[0].display_name };
    }

    document.getElementById("go").addEventListener("click", async () => {
      const q = document.getElementById("addr").value.trim();
      if (!q) return;

      const info = document.getElementById("info");
      info.innerHTML = "<p>Searching…</p>";

      const hit = await geocodeAddress(q);
      if (!hit) { info.innerHTML = "<p>No address match found.</p>"; return; }

      const regionsResp = await fetch("./regions.geojson");
      const regions = await regionsResp.json();

      const f = findContainingFeature([hit.lon, hit.lat], regions);
      if (!f) {
        info.innerHTML = `<p>Address found, but it’s outside the defined areas.</p><p><small>${hit.display}</small></p>`;
        map.setView([hit.lat, hit.lon], 14);
        return;
      }

      // Select the matching polygon in the Leaflet layer
      geoLayer.eachLayer(layer => {
        if (layer.feature?.properties?.areaId === f.properties.areaId) {
          setSelected(layer);
          map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        }
      });
    });

    loadRegions();
  </script>
</body>
</html>
